# 掌上公交汽车查询系统
## 系统设计说明书

**项目名称：** 基于移动端的掌上公交汽车查询系统  
**版本号：** 1.0  
**编制日期：** 2026年1月5日  

---

## 1. 总体架构设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                        用户层 (Presentation Layer)       │
├─────────────────────┬─────────────────┬─────────────────┤
│   Android App       │   iOS App       │  Web管理后台    │
│   (Kotlin/Java)     │   (Swift)       │  (React/Vue)    │
└──────────┬──────────┴────────┬────────┴────────┬────────┘
           │                   │                 │
           │       HTTPS/REST API               │
           │                   │                 │
┌──────────┴───────────────────┴─────────────────┴────────┐
│                   API网关层 (API Gateway)               │
│              (Nginx/Spring Cloud Gateway)               │
├──────────────────────────────────────────────────────────┤
│  - 请求路由   - 负载均衡  - 限流控制  - 鉴权认证        │
└──────────┬────────────────────────────────────────────┬─┘
           │                                            │
┌──────────┴──────────────┐             ┌───────────────┴──┐
│   业务逻辑服务层         │             │   基础服务层      │
│   (Microservices)       │             │   (Infrastructure)
├─────────────────────────┤             ├──────────────────┤
│ • User Service          │             │ • Config Server  │
│ • Route Service         │             │ • Registry       │
│ • Vehicle Service       │             │ • Log Service    │
│ • Notification Service  │             │ • Monitor        │
│ • Payment Service       │             │ • Cache Service  │
│ • Analytics Service     │             │                  │
└────────┬────────────────┘             └────────┬─────────┘
         │                                       │
         │    gRPC/Message Queue/HTTP            │
         │                                       │
┌────────┴───────────────────────────────────────┴───────┐
│              数据存储层 (Data Layer)                    │
├────────────────────────────────────────────────────────┤
│                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────┐  │
│  │  MySQL(主)   │  │  MySQL(从)   │  │ Redis缓存  │  │
│  │  (业务数据)   │  │  (只读备份)   │  │ (Session) │  │
│  └──────────────┘  └──────────────┘  └────────────┘  │
│                                                        │
│  ┌──────────────┐  ┌──────────────┐                   │
│  │  MongoDB     │  │  Elasticsearch │                  │
│  │  (GPS轨迹)   │  │  (日志索引)   │                   │
│  └──────────────┘  └──────────────┘                   │
│                                                        │
└────────────────────────────────────────────────────────┘
         │
         │
┌────────┴────────────────────────────────────────┐
│        外部集成服务层 (External Services)       │
├──────────────────────────────────────────────────┤
│ • 高德地图API/Google Maps                       │
│ • 支付宝/微信支付SDK                            │
│ • 短信/推送通知服务(阿里云SMS)                  │
│ • 文件存储(阿里云OSS)                           │
│ • CDN内容分发网络                               │
└──────────────────────────────────────────────────┘
```

### 1.2 系统分层设计

#### **表现层 (Presentation Layer)**
- **移动客户端**：Android/iOS原生应用
- **Web管理后台**：PC端管理系统
- 职责：收集用户输入，展示数据

#### **应用层 (Application Layer)**
- **API网关**：请求入口，负载均衡，鉴权
- 职责：路由、限流、监控、日志记录

#### **业务逻辑层 (Business Logic Layer)**
- 微服务架构，各服务相对独立
- 职责：实现业务逻辑，调用数据层

#### **数据访问层 (Data Access Layer)**
- ORM框架(MyBatis/Hibernate)处理数据库操作
- 职责：数据持久化、缓存管理

#### **基础设施层 (Infrastructure Layer)**
- 日志、监控、消息队列、缓存等
- 职责：支撑上层服务正常运行

---

## 2. 核心模块架构设计

### 2.1 用户服务模块 (User Service)

```
User Service Module
├─ Controller
│  ├─ UserController (用户管理接口)
│  │  ├─ register() → POST /users/register
│  │  ├─ login() → POST /users/login
│  │  ├─ updateProfile() → PUT /users/:id
│  │  └─ deleteAccount() → DELETE /users/:id
│  │
│  └─ AuthController (认证授权)
│     ├─ refreshToken() → POST /auth/refresh
│     └─ logout() → POST /auth/logout
│
├─ Service (业务逻辑)
│  ├─ UserService
│  │  ├─ registerUser(RegisterRequest)
│  │  ├─ validateLogin(credentials)
│  │  ├─ updateUserInfo(userId, userInfo)
│  │  └─ generateJWTToken(userId)
│  │
│  └─ AuthenticationService
│     ├─ authenticate(username, password)
│     └─ validateToken(token)
│
├─ Repository (数据访问)
│  ├─ UserRepository
│  │  ├─ save(User)
│  │  ├─ findById(userId)
│  │  ├─ findByPhone(phone)
│  │  └─ update(User)
│  │
│  └─ TokenRepository
│     ├─ saveToken(token, userId)
│     └─ revokeToken(token)
│
└─ Entity (数据模型)
   ├─ User
   │  ├─ userId: String (PK)
   │  ├─ phone: String (UK)
   │  ├─ email: String
   │  ├─ password: String (hashed)
   │  ├─ realName: String
   │  ├─ avatar: String
   │  ├─ status: Enum(ACTIVE, INACTIVE, BANNED)
   │  ├─ createdAt: DateTime
   │  └─ updatedAt: DateTime
   │
   └─ AuthToken
      ├─ tokenId: String
      ├─ userId: String (FK)
      ├─ token: String
      └─ expireAt: DateTime
```

### 2.2 线路与车辆服务模块 (Route & Vehicle Service)

```
Route & Vehicle Service Module
├─ Controller
│  ├─ RouteController
│  │  ├─ searchRoute() → GET /routes/search
│  │  ├─ getRouteDetail() → GET /routes/:routeId
│  │  └─ listNearbyRoutes() → GET /routes/nearby
│  │
│  └─ VehicleController
│     ├─ getVehicleLocation() → GET /vehicles/:vehicleId/location
│     ├─ getVehicleStatus() → GET /vehicles/:vehicleId/status
│     └─ listVehiclesOnRoute() → GET /routes/:routeId/vehicles
│
├─ Service (业务逻辑)
│  ├─ RouteService
│  │  ├─ searchRoute(origin, destination)
│  │  ├─ calculateETA(vehicleId, targetStation)
│  │  └─ getRouteStations(routeId)
│  │
│  └─ VehicleService
│     ├─ updateVehicleLocation(vehicleId, lat, lng)
│     ├─ calculateArrivalTime(vehicleId, stationId)
│     └─ getVehicleInfo(vehicleId)
│
├─ Repository
│  ├─ RouteRepository
│  ├─ StationRepository
│  ├─ VehicleRepository
│  └─ GPSTrajectoryRepository (MongoDB)
│
└─ Entity
   ├─ Route
   │  ├─ routeId: String (PK)
   │  ├─ routeNumber: String (UK)
   │  ├─ routeName: String
   │  ├─ startStation: String (FK)
   │  ├─ endStation: String (FK)
   │  ├─ totalDistance: Float
   │  ├─ estimatedTime: Integer
   │  ├─ operatingHours: String
   │  ├─ fareInfo: JSONObject
   │  └─ status: Enum(RUNNING, MAINTENANCE, CLOSED)
   │
   ├─ Station
   │  ├─ stationId: String (PK)
   │  ├─ stationName: String
   │  ├─ latitude: Double
   │  ├─ longitude: Double
   │  ├─ district: String
   │  └─ facilities: String[] (公交卡购买点等)
   │
   ├─ Vehicle
   │  ├─ vehicleId: String (PK)
   │  ├─ plateNumber: String (UK)
   │  ├─ routeId: String (FK)
   │  ├─ driverId: String (FK)
   │  ├─ vehicleType: String
   │  ├─ capacity: Integer
   │  ├─ currentPassengers: Integer
   │  ├─ status: Enum(RUNNING, IDLE, MAINTENANCE, OFFLINE)
   │  ├─ lastLocationUpdate: DateTime
   │  └─ nextStationId: String
   │
   └─ GPSTrajectory (MongoDB)
      ├─ trajectoryId: String
      ├─ vehicleId: String
      ├─ timestamp: DateTime
      ├─ location: GeoJSON {lat, lng}
      ├─ speed: Float
      └─ direction: Float
```

### 2.3 通知提醒服务模块 (Notification Service)

```
Notification Service Module
├─ Controller
│  └─ NotificationController
│     ├─ setReminder() → POST /reminders
│     ├─ getReminders() → GET /reminders/user/:userId
│     ├─ cancelReminder() → DELETE /reminders/:reminderId
│     └─ getNotificationHistory() → GET /notifications/history
│
├─ Service (业务逻辑)
│  ├─ ReminderService
│  │  ├─ createReminder(userId, routeId, stationId, type)
│  │  ├─ checkAndSendReminder() // 定时任务
│  │  └─ deleteReminder(reminderId)
│  │
│  ├─ NotificationService
│  │  ├─ sendPushNotification(userId, message)
│  │  ├─ sendSMSNotification(phone, message)
│  │  └─ sendInAppNotification(userId, message)
│  │
│  └─ MessageQueueService
│     └─ publishEvent(event) // 发布事件到消息队列
│
├─ Repository
│  ├─ ReminderRepository
│  └─ NotificationLogRepository
│
└─ Entity
   ├─ Reminder
   │  ├─ reminderId: String (PK)
   │  ├─ userId: String (FK)
   │  ├─ routeId: String (FK)
   │  ├─ targetStationId: String (FK)
   │  ├─ reminderType: Enum(ARRIVAL, WAITING, DEPARTURE)
   │  ├─ notificationMethod: Enum(PUSH, SMS, VOICE_CALL)
   │  ├─ createdAt: DateTime
   │  ├─ triggeredAt: DateTime
   │  └─ status: Enum(PENDING, SENT, COMPLETED, CANCELLED)
   │
   └─ Notification
      ├─ notificationId: String
      ├─ userId: String (FK)
      ├─ title: String
      ├─ content: String
      ├─ type: String
      ├─ sentAt: DateTime
      ├─ readAt: DateTime
      └─ relatedRoute/Vehicle: String
```

### 2.4 票务支付服务模块 (Payment & Ticketing Service)

```
Payment & Ticketing Service Module
├─ Controller
│  ├─ TicketController
│  │  ├─ purchaseTicket() → POST /tickets/purchase
│  │  ├─ getTicket() → GET /tickets/:ticketId
│  │  ├─ refundTicket() → POST /tickets/:ticketId/refund
│  │  └─ scanTicket() → POST /tickets/:ticketId/scan
│  │
│  └─ PaymentController
│     ├─ initiatePayment() → POST /payments
│     ├─ paymentCallback() → POST /payments/callback
│     └─ getPaymentHistory() → GET /payments/history
│
├─ Service (业务逻辑)
│  ├─ TicketService
│  │  ├─ createTicket(userId, routeId, passengers, downStation)
│  │  ├─ generateQRCode(ticketId)
│  │  ├─ validateTicket(ticketCode)
│  │  └─ processRefund(ticketId)
│  │
│  ├─ PaymentService
│  │  ├─ initiateAlipayPayment(order)
│  │  ├─ initiateWeChatPayment(order)
│  │  ├─ handlePaymentCallback(response)
│  │  └─ queryPaymentStatus(orderId)
│  │
│  └─ OrderService
│     ├─ createOrder(tickets, payment_method)
│     ├─ updateOrderStatus(orderId, status)
│     └─ calculateFare(routeId, passengers, distance)
│
├─ Repository
│  ├─ TicketRepository
│  ├─ OrderRepository
│  └─ PaymentLogRepository
│
└─ Entity
   ├─ Ticket
   │  ├─ ticketId: String (PK)
   │  ├─ orderId: String (FK)
   │  ├─ userId: String (FK)
   │  ├─ routeId: String (FK)
   │  ├─ boardingStation: String
   │  ├─ alightingStation: String
   │  ├─ passengerType: Enum(ADULT, HALF_PRICE, FREE)
   │  ├─ qrCode: String (unique)
   │  ├─ status: Enum(VALID, USED, EXPIRED, REFUNDED)
   │  ├─ usedAt: DateTime
   │  ├─ expiresAt: DateTime
   │  └─ fare: Decimal
   │
   ├─ Order
   │  ├─ orderId: String (PK)
   │  ├─ userId: String (FK)
   │  ├─ totalAmount: Decimal
   │  ├─ paymentMethod: Enum(ALIPAY, WECHAT, BALANCE)
   │  ├─ status: Enum(PENDING, PAID, CANCELLED, REFUNDED)
   │  ├─ createdAt: DateTime
   │  ├─ paidAt: DateTime
   │  └─ refundedAt: DateTime
   │
   └─ Payment
      ├─ paymentId: String
      ├─ orderId: String (FK)
      ├─ externalTransactionId: String
      ├─ channel: Enum(ALIPAY, WECHAT, UNIONPAY)
      ├─ amount: Decimal
      ├─ status: Enum(PENDING, SUCCESS, FAILED)
      └─ createdAt: DateTime
```

---

## 3. 数据库设计

### 3.1 ER图（实体关系图）

```
┌────────────────┐     ┌──────────────────┐
│     Users      │────▶│  AuthTokens      │
├────────────────┤     ├──────────────────┤
│ userId (PK)    │◀────│ tokenId (PK)     │
│ phone          │     │ userId (FK)      │
│ email          │     │ token            │
│ password       │     │ expireAt         │
│ realName       │     └──────────────────┘
│ avatar         │
│ status         │     ┌──────────────────┐
│ createdAt      │────▶│  RemindersSettings│
│ updatedAt      │     ├──────────────────┤
└────────────────┘     │ reminderId (PK)  │
        │              │ userId (FK)      │
        │              │ routeId (FK)     │
        │              │ targetStationId  │
        │              │ reminderType     │
        │              │ notificationMethod
        │              └──────────────────┘
        │
        │              ┌──────────────────┐
        └─────────────▶│  Orders          │
                       ├──────────────────┤
                       │ orderId (PK)     │
                       │ userId (FK)      │
                       │ totalAmount      │
                       │ paymentMethod    │
                       │ status           │
                       │ createdAt        │
                       │ paidAt           │
                       └──────────────────┘
                              │
                              ▼
                       ┌──────────────────┐
                       │  Tickets         │
                       ├──────────────────┤
                       │ ticketId (PK)    │
                       │ orderId (FK)     │
                       │ userId (FK)      │
                       │ routeId (FK)     │
                       │ boardingStation  │
                       │ alightingStation │
                       │ passengerType    │
                       │ qrCode           │
                       │ status           │
                       │ fare             │
                       └──────────────────┘

┌────────────────────┐     ┌──────────────────┐
│    Routes          │────▶│  Stations        │
├────────────────────┤     ├──────────────────┤
│ routeId (PK)       │     │ stationId (PK)   │
│ routeNumber (UK)   │     │ stationName      │
│ routeName          │     │ latitude         │
│ startStationId(FK) │─┐   │ longitude        │
│ endStationId (FK) ──┤   │ district         │
│ totalDistance      │ │   │ facilities       │
│ estimatedTime      │ │   └──────────────────┘
│ operatingHours     │ │          ▲
│ fareInfo           │ │          │
│ status             │ └──────────┘
│ createdAt          │
└────────────────────┘
        │
        │         ┌──────────────────┐
        ├────────▶│  RouteStations   │ (路线站点)
        │         ├──────────────────┤
        │         │ routeStationId(PK)
        │         │ routeId (FK)     │
        │         │ stationId (FK)   │
        │         │ sequenceNo       │
        │         │ distance2Next    │
        │         │ estimatedTime2Next
        │         └──────────────────┘
        │
        └────────▶│  Vehicles        │
                  ├──────────────────┤
                  │ vehicleId (PK)   │
                  │ plateNumber (UK) │
                  │ routeId (FK)     │
                  │ driverId (FK)    │
                  │ vehicleType      │
                  │ capacity         │
                  │ currentPassengers│
                  │ status           │
                  │ nextStationId    │
                  │ lastLocationUpdate
                  └──────────────────┘
                         │
                         ▼
                  ┌──────────────────┐
                  │ GPSTrajectories  │
                  ├──────────────────┤ (MongoDB)
                  │ trajectoryId     │
                  │ vehicleId        │
                  │ location (GeoJSON)
                  │ timestamp        │
                  │ speed            │
                  │ direction        │
                  └──────────────────┘

┌────────────────────┐
│    Drivers         │
├────────────────────┤
│ driverId (PK)      │
│ driverName         │
│ phone              │
│ licenseNumber      │
│ licenseExpireDate  │
│ status             │
│ createdAt          │
└────────────────────┘

┌────────────────────┐
│  Payments          │
├────────────────────┤
│ paymentId (PK)     │
│ orderId (FK)       │
│ externalTxnId      │
│ channel            │
│ amount             │
│ status             │
│ createdAt          │
└────────────────────┘

┌────────────────────┐
│  Notifications     │
├────────────────────┤
│ notificationId(PK) │
│ userId (FK)        │
│ title              │
│ content            │
│ type               │
│ sentAt             │
│ readAt             │
│ relatedRoute/Id    │
└────────────────────┘
```

### 3.2 数据库表设计（DDL语句）

```sql
-- 用户表
CREATE TABLE users (
  user_id VARCHAR(36) PRIMARY KEY COMMENT '用户ID',
  phone VARCHAR(20) UNIQUE NOT NULL COMMENT '手机号',
  email VARCHAR(100) UNIQUE COMMENT '邮箱',
  password VARCHAR(255) NOT NULL COMMENT '密码(加密)',
  real_name VARCHAR(50) COMMENT '真实姓名',
  avatar VARCHAR(500) COMMENT '头像URL',
  gender ENUM('MALE', 'FEMALE', 'UNKNOWN') DEFAULT 'UNKNOWN',
  status ENUM('ACTIVE', 'INACTIVE', 'BANNED') DEFAULT 'ACTIVE',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP COMMENT '软删除时间',
  INDEX idx_phone (phone),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 认证token表
CREATE TABLE auth_tokens (
  token_id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  token VARCHAR(500) NOT NULL UNIQUE,
  token_type ENUM('ACCESS', 'REFRESH') DEFAULT 'ACCESS',
  expire_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  INDEX idx_user_id (user_id),
  INDEX idx_expire_at (expire_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 公交线路表
CREATE TABLE routes (
  route_id VARCHAR(36) PRIMARY KEY,
  route_number VARCHAR(20) UNIQUE NOT NULL COMMENT '线路编号(如:201路)',
  route_name VARCHAR(100) NOT NULL COMMENT '线路名称',
  start_station_id VARCHAR(36) NOT NULL COMMENT '起点站ID',
  end_station_id VARCHAR(36) NOT NULL COMMENT '终点站ID',
  total_distance FLOAT COMMENT '总里程(km)',
  estimated_time INT COMMENT '预计用时(分钟)',
  operating_hours VARCHAR(50) COMMENT '运营时间',
  fare_info JSON COMMENT '票价信息(成人/儿童/老人)',
  status ENUM('RUNNING', 'MAINTENANCE', 'CLOSED') DEFAULT 'RUNNING',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (start_station_id) REFERENCES stations(station_id),
  FOREIGN KEY (end_station_id) REFERENCES stations(station_id),
  INDEX idx_route_number (route_number),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 公交站点表
CREATE TABLE stations (
  station_id VARCHAR(36) PRIMARY KEY,
  station_name VARCHAR(100) NOT NULL,
  latitude DOUBLE NOT NULL COMMENT '纬度',
  longitude DOUBLE NOT NULL COMMENT '经度',
  district VARCHAR(50) COMMENT '所在区域',
  facilities VARCHAR(500) COMMENT '周边设施(JSON格式)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  SPATIAL INDEX idx_location (POINT(latitude, longitude)),
  INDEX idx_district (district)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 路线站点关联表(路线包含多个站点)
CREATE TABLE route_stations (
  route_station_id VARCHAR(36) PRIMARY KEY,
  route_id VARCHAR(36) NOT NULL,
  station_id VARCHAR(36) NOT NULL,
  sequence_no INT NOT NULL COMMENT '站点顺序',
  distance_to_next FLOAT COMMENT '到下一站距离(km)',
  estimated_time_to_next INT COMMENT '到下一站预计时间(分钟)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (route_id) REFERENCES routes(route_id),
  FOREIGN KEY (station_id) REFERENCES stations(station_id),
  UNIQUE KEY unique_route_station (route_id, station_id),
  INDEX idx_route_id (route_id),
  INDEX idx_sequence (route_id, sequence_no)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 驾驶员表
CREATE TABLE drivers (
  driver_id VARCHAR(36) PRIMARY KEY,
  driver_name VARCHAR(50) NOT NULL,
  phone VARCHAR(20) UNIQUE NOT NULL,
  id_number VARCHAR(20) UNIQUE NOT NULL COMMENT '身份证号',
  license_number VARCHAR(50) UNIQUE NOT NULL COMMENT '驾驶证号',
  license_expire_date DATE NOT NULL,
  status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') DEFAULT 'ACTIVE',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_license (license_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 公交车表
CREATE TABLE vehicles (
  vehicle_id VARCHAR(36) PRIMARY KEY,
  plate_number VARCHAR(20) UNIQUE NOT NULL COMMENT '车牌号',
  route_id VARCHAR(36) NOT NULL,
  driver_id VARCHAR(36),
  vehicle_type VARCHAR(50) COMMENT '车型(如:公交大巴)',
  capacity INT NOT NULL COMMENT '载客数',
  current_passengers INT DEFAULT 0 COMMENT '当前乘客数',
  status ENUM('RUNNING', 'IDLE', 'MAINTENANCE', 'OFFLINE') DEFAULT 'IDLE',
  next_station_id VARCHAR(36) COMMENT '下一个站点',
  last_location_update TIMESTAMP COMMENT '最后位置更新时间',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (route_id) REFERENCES routes(route_id),
  FOREIGN KEY (driver_id) REFERENCES drivers(driver_id),
  FOREIGN KEY (next_station_id) REFERENCES stations(station_id),
  INDEX idx_plate_number (plate_number),
  INDEX idx_route_id (route_id),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 提醒设置表
CREATE TABLE reminders (
  reminder_id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  route_id VARCHAR(36) NOT NULL,
  target_station_id VARCHAR(36) NOT NULL,
  reminder_type ENUM('ARRIVAL', 'WAITING', 'DEPARTURE') COMMENT '提醒类型',
  notification_method ENUM('PUSH', 'SMS', 'VOICE_CALL', 'ALL') DEFAULT 'PUSH',
  status ENUM('PENDING', 'SENT', 'COMPLETED', 'CANCELLED') DEFAULT 'PENDING',
  triggered_at TIMESTAMP COMMENT '触发时间',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (route_id) REFERENCES routes(route_id),
  FOREIGN KEY (target_station_id) REFERENCES stations(station_id),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 订单表
CREATE TABLE orders (
  order_id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  total_amount DECIMAL(10, 2) NOT NULL,
  payment_method ENUM('ALIPAY', 'WECHAT', 'BALANCE', 'CARD') DEFAULT 'ALIPAY',
  status ENUM('PENDING', 'PAID', 'CANCELLED', 'REFUNDED') DEFAULT 'PENDING',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  paid_at TIMESTAMP COMMENT '支付时间',
  refunded_at TIMESTAMP COMMENT '退款时间',
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 车票表
CREATE TABLE tickets (
  ticket_id VARCHAR(36) PRIMARY KEY,
  order_id VARCHAR(36) NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  route_id VARCHAR(36) NOT NULL,
  boarding_station_id VARCHAR(36) NOT NULL,
  alighting_station_id VARCHAR(36) NOT NULL,
  passenger_type ENUM('ADULT', 'HALF_PRICE', 'FREE') DEFAULT 'ADULT',
  qr_code VARCHAR(500) UNIQUE NOT NULL COMMENT '二维码(可扫码乘车)',
  status ENUM('VALID', 'USED', 'EXPIRED', 'REFUNDED') DEFAULT 'VALID',
  fare DECIMAL(10, 2),
  used_at TIMESTAMP COMMENT '使用时间',
  expires_at TIMESTAMP NOT NULL COMMENT '过期时间',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (order_id) REFERENCES orders(order_id),
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (route_id) REFERENCES routes(route_id),
  FOREIGN KEY (boarding_station_id) REFERENCES stations(station_id),
  FOREIGN KEY (alighting_station_id) REFERENCES stations(station_id),
  UNIQUE KEY unique_qr_code (qr_code),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  INDEX idx_route_id (route_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 支付表
CREATE TABLE payments (
  payment_id VARCHAR(36) PRIMARY KEY,
  order_id VARCHAR(36) NOT NULL,
  external_transaction_id VARCHAR(100) COMMENT '第三方交易号',
  channel ENUM('ALIPAY', 'WECHAT', 'UNIONPAY') NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  status ENUM('PENDING', 'SUCCESS', 'FAILED', 'CANCELLED') DEFAULT 'PENDING',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP COMMENT '支付完成时间',
  FOREIGN KEY (order_id) REFERENCES orders(order_id),
  INDEX idx_order_id (order_id),
  INDEX idx_status (status),
  UNIQUE KEY unique_external_txn (external_transaction_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 通知表
CREATE TABLE notifications (
  notification_id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  title VARCHAR(100) NOT NULL,
  content TEXT NOT NULL,
  type VARCHAR(50) COMMENT '通知类型(到站/延误等)',
  related_route_id VARCHAR(36) COMMENT '相关线路ID',
  related_vehicle_id VARCHAR(36) COMMENT '相关车辆ID',
  sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  read_at TIMESTAMP COMMENT '阅读时间',
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (related_route_id) REFERENCES routes(route_id),
  FOREIGN KEY (related_vehicle_id) REFERENCES vehicles(vehicle_id),
  INDEX idx_user_id (user_id),
  INDEX idx_sent_at (sent_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 4. 关键算法设计

### 4.1 ETA (预计到站时间)计算算法

```pseudocode
Function CalculateETA(vehicleId, targetStationId):
    // 获取车辆当前信息
    currentLocation = GetVehicleLocation(vehicleId)
    currentSpeed = GetVehicleSpeed(vehicleId)
    route = GetVehicleRoute(vehicleId)
    
    // 获取路线信息
    remainingStations = GetStationsFromCurrent(route, targetStationId)
    
    totalTime = 0
    
    For each station in remainingStations:
        // 获取当前站到下一站的距离和标准时间
        distance = GetDistanceToNextStation(station)
        standardTime = GetStandardTime(station)
        
        // 考虑实时路况调整时间
        trafficFactor = GetTrafficFactor(station.location)
        adjustedTime = standardTime * trafficFactor
        
        // 考虑当前车速
        if currentSpeed > 0:
            estimatedTime = distance / currentSpeed * 60 // 转换为分钟
        else:
            estimatedTime = adjustedTime
        
        totalTime += Min(estimatedTime, adjustedTime * 1.5) // 不超过标准时间的1.5倍
    
    Return totalTime
```

### 4.2 最优线路推荐算法

```pseudocode
Function RecommendOptimalRoute(origin, destination, criteria):
    // criteria: 'shortest' 最短距离, 'fastest' 最快时间, 'cheapest' 最便宜
    
    // 第1步: 查找可达线路
    availableRoutes = FindReachableRoutes(origin, destination)
    
    // 第2步: 计算每条线路的评分
    routeScores = []
    
    For each route in availableRoutes:
        distance = CalculateDistance(route)
        estimatedTime = CalculateRouteTime(route)
        fare = CalculateFare(route)
        
        // 计算综合评分(0-100)
        if criteria == 'shortest':
            score = 100 - (distance / maxDistance * 100)
        else if criteria == 'fastest':
            score = 100 - (estimatedTime / maxTime * 100)
        else if criteria == 'cheapest':
            score = 100 - (fare / maxFare * 100)
        
        // 考虑候车时间(权重0.2)
        waitTime = GetEstimatedWaitTime(route)
        score = score * 0.8 + (100 - waitTime / maxWaitTime * 100) * 0.2
        
        routeScores.append({route, score})
    
    // 第3步: 排序并返回top-3
    return Sort(routeScores, descending).Top(3)
```

---

## 5. 系统安全设计

### 5.1 认证与授权
- **认证方式**：JWT Token + Refresh Token
- **Token有效期**：Access Token 2小时，Refresh Token 7天
- **授权模型**：RBAC(基于角色的访问控制)

### 5.2 数据安全
- **传输加密**：HTTPS/TLS 1.2+
- **存储加密**：用户密码采用bcrypt加密，敏感数据AES-256加密
- **API安全**：请求签名、时间戳验证防止重放攻击

### 5.3 隐私保护
- **GPS数据处理**：定期清除历史轨迹数据(>30天)
- **个人信息脱敏**：手机号、身份证号加密存储
- **日志管理**：敏感操作日志，防止数据泄露

---

## 6. 部署架构

### 6.1 服务器部署拓扑

```
Internet
    │
    ▼
┌─────────────────────┐
│  CDN (阿里云)       │ (静态资源分发)
└─────────────────────┘
    │
    ▼
┌──────────────────────┐
│  负载均衡器(SLB)     │ (支持HTTPS)
└──────┬───────────────┘
       │
   ┌───┴───────────┬──────────────┬───────────┐
   │               │              │           │
   ▼               ▼              ▼           ▼
┌─────────┐   ┌─────────┐   ┌─────────┐ ┌─────────┐
│ECS 1    │   │ECS 2    │   │ECS 3    │ │ECS 4    │
│(API服务)│   │(API服务)│   │(API服务)│ │(API服务)│
└────┬────┘   └────┬────┘   └────┬────┘ └────┬────┘
     │             │             │           │
     └─────────────┼─────────────┴───────────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
    ┌─────────────┐   ┌──────────────┐
    │ RDS MySQL   │   │ Redis 集群   │
    │(主从复制)    │   │(缓存/Session)│
    └─────────────┘   └──────────────┘
        │
        ▼
    ┌──────────────┐
    │ MongoDB      │
    │(GPS轨迹数据) │
    └──────────────┘

消息队列和定时任务:
┌─────────────────┐
│ MQ (RabbitMQ)   │ (事件驱动/异步任务)
├─────────────────┤
│ • 提醒任务队列   │
│ • 支付回调队列   │
│ • 日志队列      │
└─────────────────┘

监控和日志:
┌──────────────────┐  ┌──────────────────┐
│ ELK Stack        │  │ Prometheus       │
│(日志收集/分析)    │  │(系统监控)         │
└──────────────────┘  └──────────────────┘
```

---

## 7. 性能优化

### 7.1 缓存策略
- **多层缓存**：Redis缓存热点数据(线路、站点)，本地缓存常用数据
- **缓存更新**：TTL 60分钟，数据变更时主动更新

### 7.2 数据库优化
- **索引优化**：为常用查询字段(user_id, status, route_id)建索引
- **分库分表**：订单表按user_id分库分表(256个逻辑库)

### 7.3 并发处理
- **限流**：使用令牌桶算法，API限流100 req/s
- **异步处理**：通知、支付回调通过消息队列异步处理

---

**文档版本历史**

| 版本 | 日期 | 修改说明 | 作者 |
|-----|------|--------|------|
| 1.0 | 2026-01-05 | 初始版本 | 学生 |

